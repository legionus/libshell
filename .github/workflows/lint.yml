name: Lint

on:
  push:
    branches: [ master, for-master ]
  pull_request:
    branches: [ master, for-master ]

jobs:
  check-commits:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "Current environ"
        run: env | sort

      - name: "github object"
        run: |
          cat >/dev/null <<EOF
          ${{ toJSON(github) }}
          EOF

      - name: "github event"
        run: |
          cat >/dev/null <<EOF
          ${{ toJSON(github.event) }}
          EOF

      - name: "Developer's Certificate of Origin"
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            from="${{ github.event.before }}"
            to="HEAD"
          else
            from="${{ github.event.pull_request.base.sha }}"
            to="HEAD"
          fi
          echo
          echo "Commits between $from and $to:"
          git log --pretty='%H%x09%s%x09%ce%x09-%(trailers:key=Signed-off-by,valueonly,separator=%x00)' $from..$to > /tmp/commits
          cut -f1,2 < /tmp/commits
          echo ''
          if grep -e '-$' /tmp/commits | cut -f1,2 | grep -e '^' > /tmp/bad-commits; then
             echo 'Ð¡ommits that fail verification:'
             cat /tmp/bad-commits
             echo ''
             echo 'The DCO Signoff Check for all commits has FAILED.'
             echo 'See https://github.com/legionus/libshell/blob/master/CONTRIBUTING.md'
             echo ''
             exit 1
          fi

  lint-shell:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: sudo apt-get -y -qq install shellcheck
      - run: make verify

  check-docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: sudo apt-get -y -qq install scdoc
      - run: make man

  check-shells:
    runs-on: ubuntu-latest
    needs:
      - lint-shell
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: dash
            pkgs: dash

          - name: bash
            pkgs: bash

          - name: mksh
            pkgs: mksh

          - name: lksh
            pkgs: mksh

    name: "check with ${{ matrix.name }}"
    steps:
      - uses: actions/checkout@v4
      - run: sudo apt-get -y -qq install ${{ matrix.pkgs }}
      - run: make check V=1 CHECK_SHELL=/bin/${{ matrix.name }}
